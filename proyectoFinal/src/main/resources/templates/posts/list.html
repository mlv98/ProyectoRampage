<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="es">
<head th:replace="fragments/head :: head('Listado de Posts')"></head>
<body class="text-gray-100 antialiased" style="background: linear-gradient(135deg, #000000 0%, #1a1a1a 40%, #333333 100%);">
  <div th:replace="fragments/header :: header"></div>
  <div style="height:4rem;"></div>

  <main class="w-full max-w-xl sm:max-w-2xl lg:max-w-3xl mx-auto bg-white dark:bg-gray-900 rounded-3xl shadow-xl p-8 my-12">
    <h1 class="text-4xl lg:text-5xl font-bold text-center mb-6">Publicaciones</h1>
    <a class="btn-new inline-flex items-center px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition mb-6"
       th:href="@{/posts/new}">+ Nueva publicaci√≥n</a>

    <section th:if="${posts.hasContent()}" class="space-y-8">
      <ul class="space-y-8">
        <li th:each="post : ${posts.content}" th:id="'post-' + ${post.id}"
            class="post-card py-4 px-4 bg-white dark:bg-gray-800 rounded-2xl shadow-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">

          <!-- HEADER -->
          <header class="flex items-center mb-4">
            <img class="w-10 h-10 rounded-full mr-3 object-cover flex-shrink-0"
                 th:src="${post.author.avatarUrl} != null ? @{${post.author.avatarUrl}} : @{/images/default-avatar.png}"
                 alt="Avatar de [[${post.author.nombre}]]" />
            <div>
              <p class="font-semibold text-gray-900 dark:text-gray-100" th:text="${post.author.nombre}">Autor</p>
              <time class="text-sm text-gray-500 dark:text-gray-400"
                    th:datetime="${post.createdAt}"
                    th:text="${#temporals.format(post.createdAt,'dd MMM yyyy HH:mm')}">01 Ene 2025 12:00</time>
            </div>
          </header>

          <!-- INLINE EDIT FORM (hidden by default) -->
          <form th:action="@{'/posts/' + ${post.id} + '/edit'}" method="post" class="edit-form hidden space-y-4">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="_method" value="put" />
            <input type="text" name="title" th:value="${post.title}" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2" />
            <textarea name="content" rows="3" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2" th:text="${post.content}"></textarea>
            <div class="flex space-x-2">
              <button type="submit" class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg">Guardar</button>
              <button type="button" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg cancel-edit">Cancelar</button>
            </div>
          </form>

          <!-- VIEW MODE -->
          <div class="view-mode space-y-4">
            <!-- CUERPO -->
            <div class="post-body mb-4">
              <h2 class="text-2xl font-bold mb-2 text-gray-900 dark:text-gray-100" th:text="${post.title}">T√≠tulo del Post</h2>
              <p class="text-gray-700 dark:text-gray-300" th:text="${post.content}">Contenido del post‚Ä¶</p>
            </div>
            <!-- MEDIA -->
            <div class="post-media mb-4" th:if="${!post.media.isEmpty()}">
              <div th:each="m : ${post.media}" class="mb-2">
                <div th:if="${m.type.name() == 'IMAGE'}">
                  <a th:href="@{${m.path}}" data-lightbox="post-[[${post.id}]]" data-title="[[${post.title}]]">
                    <img th:src="@{${m.path}}" class="block mx-auto max-w-full rounded" alt="Imagen" />
                  </a>
                </div>
                <div th:if="${m.type.name() == 'VIDEO'}">
                  <video muted loop preload="none" controls th:src="@{${m.path}}" class="block mx-auto max-w-full rounded-lg"></video>
                </div>
              </div>
            </div>

            <!-- FOOTER ACCIONES -->
            <footer class="flex items-center space-x-4 mb-4">
              <button class="btn-action btn-like flex items-center space-x-1" aria-pressed="false" th:attr="data-post-id=${post.id}">
                <i class="icon fa-regular fa-heart"></i>
                <span class="label">Like</span>
                <span class="count" th:text="${post.likeCount}">0</span>
              </button>
              <button class="btn-action btn-comment flex items-center space-x-1" aria-expanded="false">
                <i class="fa-regular fa-comment"></i>
                <span class="label">Comentarios</span>
              </button>
              <a th:if="${#authentication.name == post.author.email}" href="#" class="edit-btn text-blue-600 hover:text-blue-800 flex items-center space-x-1">
                <i class="fa-solid fa-pen-to-square"></i><span>Editar</span>
              </a>
              <form th:if="${#authentication.name == post.author.email}" th:action="@{'/posts/' + ${post.id} + '/delete'}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="btn-action btn-delete">üóëÔ∏è</button>
              </form>
            </footer>

               <!-- SECCI√ìN DE COMENTARIOS -->
<div class="comments-section bg-gray-50 dark:bg-gray-800 p-6 rounded-2xl border border-gray-200 dark:border-gray-700" hidden>
  <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Comentarios</h3>
  <ul class="divide-y divide-gray-200 dark:divide-gray-700 mb-4">
    <li th:each="c : ${post.comments}" class="py-4 flex items-start space-x-3">
      <img th:src="${c.author.avatarUrl} != null ? @{${c.author.avatarUrl}} : @{/images/default-avatar.png}" class="w-10 h-10 rounded-full mr-3 object-cover flex-shrink-0" alt="Avatar"/>
      <div class="flex-1">
        <div class="flex justify-between items-center">
          <p class="text-sm font-medium text-gray-900 dark:text-gray-100" th:text="${c.author.nombre}">Autor</p>
          <time class="text-xs text-gray-500 dark:text-gray-400" th:datetime="${c.createdAt}" th:text="${#temporals.format(c.createdAt,'dd/MM/yyyy HH:mm')}">08/05/2025 21:00</time>
        </div>
        <p class="mt-1 text-gray-700 dark:text-gray-300" th:text="${c.text}">Comentario‚Ä¶</p>
         <div th:if="${#authentication.name == c.author.email}" class="mt-2">
      <form th:action="@{'/posts/' + ${post.id} + '/comments/' + ${c.id} + '/delete'}"
            method="post" class="inline">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit"
                class="text-red-600 hover:text-red-800 text-sm flex items-center space-x-1">
          <i class="fa-solid fa-trash-can"></i>
          <span>Eliminar</span>
        </button>
      </form>
    </div>
    </li>
    <li th:if="${#lists.isEmpty(post.comments)}" class="py-4 text-center text-gray-500">No hay comentarios a√∫n.</li>
  </ul>
  <form th:action="@{'/posts/' + ${post.id} + '/comments'}" method="post" class="flex space-x-2">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <textarea name="text" required class="flex-1 border border-gray-300 dark:border-gray-600 rounded-lg p-2 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100" placeholder="Escribe tu comentario‚Ä¶"></textarea>
    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Enviar</button>
  </form>
</div>
          </div>
        </li>
      </ul>

      <!-- PAGINACI√ìN -->
      <nav class="flex justify-between mt-6">
        <a th:href="@{/posts(page=${posts.number - 1})}" th:if="${posts.hasPrevious()}" class="px-3 py-1 bg-gray-200 rounded">¬´ Anterior</a>
        <span>P√°gina <strong th:text="${posts.number + 1}">1</strong> de <strong th:text="${posts.totalPages}">1</strong></span>
        <a th:href="@{/posts(page=${posts.number + 1})}" th:if="${posts.hasNext()}" class="px-3 py-1 bg-gray-200 rounded">Siguiente ¬ª</a>
      </nav>
    </section>

    <section th:if="${!posts.hasContent()}" class="text-center py-10">
      <p>No hay posts todav√≠a.</p>
    </section>
  </main>

  <div th:replace="fragments/footer :: footer"></div>

  <!-- Scripts -->
  <script defer th:src="@{/js/posts.js}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js" defer></script>

</body>
</html>
